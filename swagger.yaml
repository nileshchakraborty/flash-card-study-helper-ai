openapi: 3.0.1
info:
  title: Flash Card Study Helper AI API
  version: 1.0.0
  description: API contract between frontend and backend for flashcard generation, search, upload, quiz and analytics.
servers:
  - url: http://localhost:3000
    description: Local development server
paths:
  /api/generate:
    post:
      summary: Generate flashcards
      description: Generate flashcards for a given topic. Supports Ollama and WebLLM runtimes.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GenerateRequest"
      responses:
        "200":
          description: Successful generation
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenerateResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/generate/from-content:
    post:
      summary: Generate flashcards from raw content
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GenerateFromContentRequest"
      responses:
        "200":
          description: Generated flashcards
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenerateResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/search:
    post:
      summary: Search the web
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SearchRequest"
      responses:
        "200":
          description: Search results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SearchResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/scrape:
    post:
      summary: Scrape provided URLs
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ScrapeRequest"
      responses:
        "200":
          description: Scraped content
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ScrapeResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/upload:
    post:
      summary: Upload a file (PDF, image) for flashcard generation
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/UploadRequest"
      responses:
        "200":
          description: Generated cards from uploaded file
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UploadResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/jobs/{id}:
    get:
      summary: Get asynchronous job status
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Job ID
      responses:
        "200":
          description: Job status and result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JobStatusResponse"
        "404":
          description: Job not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/queue/stats:
    get:
      summary: Get queue statistics
      description: Retrieve current statistics of the job queue (admin only)
      responses:
        "200":
          description: Queue statistics
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QueueStats"
        "401":
          description: Unauthorized
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/brief-answer:
    post:
      summary: Get a brief answer for a question using context
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BriefAnswerRequest"
      responses:
        "200":
          description: Brief answer
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BriefAnswerResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/flashcards:
    get:
      summary: Retrieve all flashcards (initial load)
      responses:
        "200":
          description: Empty array or stored cards
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FlashcardsResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/quiz:
    post:
      summary: Generate a quiz from provided cards
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/QuizRequest"
      responses:
        "200":
          description: Quiz questions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuizResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/quiz/generate-advanced:
    post:
      summary: Generate advanced quiz based on previous results
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AdvancedQuizRequest"
      responses:
        "200":
          description: Advanced quiz data
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdvancedQuizResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/quiz/history:
    get:
      summary: Retrieve quiz history
      responses:
        "200":
          description: List of past quizzes
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuizHistoryResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Save a quiz result
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/QuizResultRequest"
      responses:
        "200":
          description: Quiz result saved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuizResultResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/webllm/session:
    post:
      summary: Create a new WebLLM session
      description: Creates a WebLLM session for browser-based LLM generation via WebSocket
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WebLLMSessionRequest"
      responses:
        "200":
          description: Session created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WebLLMSessionResponse"
        "401":
          description: Unauthorized
        "500":
          description: Server error
    get:
      summary: Get WebLLM session status
      description: Retrieve status of an existing WebLLM session
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Session ID
      responses:
        "200":
          description: Session status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WebLLMSessionStatus"
        "404":
          description: Session not found
        "401":
          description: Unauthorized
    delete:
      summary: Close WebLLM session
      description: Close and cleanup a WebLLM session
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Session ID
      responses:
        "200":
          description: Session closed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        "401":
          description: Unauthorized
  /api/webllm/stats:
    get:
      summary: Get WebLLM service statistics
      description: Get statistics about active WebLLM sessions
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Service statistics
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WebLLMStats"
        "401":
          description: Unauthorized
  /api/webllm/ws:
    get:
      summary: WebSocket endpoint for WebLLM
      description: |
        WebSocket connection for real-time WebLLM communication.
        Connect with: `ws://host/api/webllm/ws?sessionId=<sessionId>`

        **Message Format (Client → Server):**
        ```json
        {
          "type": "generate",
          "prompt": "Generate flashcards about Neural Networks",
          "options": { "count": 10, "topic": "Neural Networks" }
        }
        ```

        **Message Format (Server → Client):**
        ```json
        {
          "type": "progress",
          "progress": 50,
          "message": "Generating..."
        }
        ```
        ```json
        {
          "type": "result",
          "data": { "cards": [...] }
        }
        ```
      parameters:
        - in: query
          name: sessionId
          required: true
          schema:
            type: string
          description: WebLLM session ID
      responses:
        "101":
          description: Switching Protocols (WebSocket upgrade)

  /api/decks:
    get:
      summary: Retrieve deck history
      responses:
        "200":
          description: List of decks
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeckHistoryResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Save a generated deck
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DeckSaveRequest"
      responses:
        "200":
          description: Save confirmation
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeckSaveResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/swipe:
    post:
      summary: Record a swipe action (left/right)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SwipeRequest"
      responses:
        "200":
          description: Acknowledgement
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SwipeResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/health:
    get:
      summary: Health check for backend services
      responses:
        "200":
          description: Service health status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
components:
  schemas:
    JobStatusResponse:
      type: object
      properties:
        status:
          type: string
          enum: [waiting, active, completed, failed, delayed]
        progress:
          type: integer
        result:
          type: object
          description: Standardized result object (never a string)
          properties:
            cards:
              type: array
              items:
                $ref: "#/components/schemas/Flashcard"
        error:
          type: string
    GenerateRequest:
      type: object
      required:
        - topic
        - count
      properties:
        topic:
          type: string
          description: Topic for flashcard generation
        count:
          type: integer
          description: Number of flashcards to generate
        runtime:
          type: string
          enum: [ollama, webllm]
          description: Which AI runtime to use
        preferredRuntime:
          type: string
          enum: [ollama, webllm]
          description: User-preferred runtime; server falls back to alternate then local validation
        knowledgeSource:
          type: string
          enum: [ai-only, web-only, ai-web]
          description: Source of knowledge for generation
        mode:
          type: string
          enum: [standard, deep-dive]
          description: Generation mode
    GenerateResponse:
      type: object
      properties:
        success:
          type: boolean
        cards:
          type: array
          items:
            $ref: "#/components/schemas/Flashcard"
        recommendedTopics:
          type: array
          items:
            type: string
        metadata:
          $ref: "#/components/schemas/Metadata"
    Flashcard:
      type: object
      properties:
        id:
          type: string
        front:
          type: string
        back:
          type: string
        topic:
          type: string
    Metadata:
      type: object
      properties:
        runtime:
          type: string
        knowledgeSource:
          type: string
        timestamp:
          type: integer
    SearchRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
    SearchResponse:
      type: object
      properties:
        success:
          type: boolean
        results:
          type: array
          items:
            type: object
            properties:
              title:
                type: string
              link:
                type: string
              snippet:
                type: string
    ScrapeRequest:
      type: object
      required:
        - urls
      properties:
        urls:
          type: array
          items:
            type: string
    ScrapeResponse:
      type: object
      properties:
        success:
          type: boolean
        content:
          type: string
    UploadRequest:
      type: object
      properties:
        file:
          type: string
          format: binary
        topic:
          type: string
    UploadResponse:
      type: object
      properties:
        success:
          type: boolean
        cards:
          type: array
          items:
            $ref: "#/components/schemas/Flashcard"
    BriefAnswerRequest:
      type: object
      required:
        - question
        - context
      properties:
        question:
          type: string
        context:
          type: string
    BriefAnswerResponse:
      type: object
      properties:
        success:
          type: boolean
        briefAnswer:
          type: string
    FlashcardsResponse:
      type: object
      properties:
        cards:
          type: array
          items:
            $ref: "#/components/schemas/Flashcard"
    QuizRequest:
      type: object
      properties:
        topic:
          type: string
          description: Topic to generate quiz from (mutually exclusive with flashcardIds)
        flashcardIds:
          type: array
          items:
            type: string
          description: Array of flashcard IDs to generate quiz from (mutually exclusive with topic)
        numQuestions:
          type: integer
          description: "Number of questions to generate (default: 5 or 10)"
      example:
        topic: "Neural Networks"
        numQuestions: 5
    QuizResponse:
      type: object
      properties:
        questions:
          type: array
          items:
            $ref: "#/components/schemas/QuizQuestion"
    QuizQuestion:
      type: object
      properties:
        id:
          type: string
        cardId:
          type: string
        question:
          type: string
        correctAnswer:
          type: string
        options:
          type: array
          items:
            type: string
    AdvancedQuizRequest:
      type: object
      required:
        - previousResults
        - mode
      properties:
        previousResults:
          type: array
          items:
            type: object
        mode:
          type: string
    AdvancedQuizResponse:
      type: object
      properties:
        success:
          type: boolean
        quiz:
          type: object
    QuizHistoryResponse:
      type: object
      properties:
        history:
          type: array
          items:
            type: object
    QuizResultRequest:
      type: object
      properties:
        result:
          type: object
    QuizResultResponse:
      type: object
      properties:
        success:
          type: boolean
        id:
          type: string
    DeckHistoryResponse:
      type: object
      properties:
        history:
          type: array
          items:
            $ref: "#/components/schemas/Deck"
    Deck:
      type: object
      properties:
        id:
          type: string
        topic:
          type: string
        cards:
          type: array
          items:
            $ref: "#/components/schemas/Flashcard"
        timestamp:
          type: integer
    DeckSaveRequest:
      type: object
      required:
        - topic
        - cards
      properties:
        topic:
          type: string
        cards:
          type: array
          items:
            $ref: "#/components/schemas/Flashcard"
    DeckSaveResponse:
      type: object
      properties:
        success:
          type: boolean
        id:
          type: string
    SwipeRequest:
      type: object
      required:
        - direction
        - cardId
      properties:
        direction:
          type: string
          enum: [left, right]
        cardId:
          type: string
    SwipeResponse:
      type: object
      properties:
        success:
          type: boolean
    HealthResponse:
      type: object
      properties:
        ollama:
          type: boolean
        serper:
          type: boolean
        webllm:
          type: boolean
    WebLLMSessionRequest:
      type: object
      required:
        - modelId
      properties:
        modelId:
          type: string
          description: WebLLM model ID (e.g., 'Llama-3-8B-Instruct-q4f16_1-MLC')
          example: "Llama-3-8B-Instruct-q4f16_1-MLC"
    WebLLMSessionResponse:
      type: object
      properties:
        sessionId:
          type: string
          description: Unique session identifier
        wsUrl:
          type: string
          description: WebSocket URL for this session
        modelId:
          type: string
          description: Model ID for this session
        status:
          type: string
          enum: [initializing, ready, generating, error, closed]
    WebLLMSessionStatus:
      type: object
      properties:
        id:
          type: string
        modelId:
          type: string
        status:
          type: string
          enum: [initializing, ready, generating, error, closed]
        createdAt:
          type: integer
          format: int64
        lastActivity:
          type: integer
          format: int64
    WebLLMStats:
      type: object
      properties:
        totalSessions:
          type: integer
        activeSessions:
          type: integer
        sessionsByStatus:
          type: object
          additionalProperties:
            type: integer
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
    GenerateFromContentRequest:
      type: object
      required:
        - type
        - content
      properties:
        type:
          type: string
          enum: [text, url]
        content:
          oneOf:
            - type: string
            - type: array
              items:
                type: string
        topic:
          type: string
    QueueStats:
      type: object
      properties:
        waiting:
          type: integer
        active:
          type: integer
        completed:
          type: integer
        failed:
          type: integer
        delayed:
          type: integer
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWE
      description: JWE (JSON Web Encryption) token obtained from OAuth callback
